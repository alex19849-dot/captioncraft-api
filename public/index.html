<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>CaptionCraft ‚Äì AI Caption Generator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0f1115; --card:#171a21; --muted:#8b95a7; --line:#2f3852; --text:#e8ecf1; --accent:#6ee7ff;
    }
    *{box-sizing:border-box}
   body{
  margin:0;
  font-family:system-ui,sans-serif;
  background:#0f1115;
  color:#e8ecf1;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:flex-start;
  min-height:100vh;
  padding-top:30px;
}
    .card{
      width:100%; max-width:900px; background:var(--card); border:1px solid var(--line);
      border-radius:16px; padding:22px; box-shadow:0 10px 36px rgba(0,0,0,.45);
    }
    h1{margin:0 0 8px; text-align:center; color:var(--accent)}
    .sub{margin:0 0 18px; text-align:center; color:var(--muted); font-size:14px}
    label{display:block; margin:12px 0 6px; color:var(--muted); font-size:14px}
    textarea,input,select,button{
      width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--line); background:#0e121a; color:var(--text); font-size:14px;
    }
    select{cursor:pointer}
    .row{display:grid; gap:12px}
    @media(min-width:720px){ .row{grid-template-columns:2fr 1fr} }
    button.primary{
      margin-top:14px; font-weight:700; cursor:pointer;
      background:linear-gradient(180deg,#1b2640,#121a2d);
      box-shadow:0 4px 12px rgba(84,164,255,.18);
    }
    .meta{display:flex; gap:10px; align-items:center; margin-top:8px; font-size:13px; color:var(--muted)}
    .badge{display:inline-flex; align-items:center; gap:6px; font-size:12px; padding:4px 8px; border:1px solid var(--line); border-radius:999px; color:var(--muted)}
    .pro{border-color:#3aa471; color:#87e4a5}
    .danger{color:#ff6b6b}
    #outputs{margin-top:20px; display:grid; gap:10px}
    .out{background:#0f1420; border:1px solid #232838; border-radius:12px; padding:10px}
    .actions{display:flex; gap:10px; flex-wrap:wrap; margin-top:8px}
    .lock{opacity:.55; cursor:not-allowed}
    .tooltip{font-size:12px; color:var(--muted)}

    /* Modal */
    .modal-backdrop{
      position:fixed; inset:0; background:rgba(0,0,0,.6);
      display:none; align-items:center; justify-content:center; z-index:9999;
    }
    .modal{background:#121621; border:1px solid var(--line); border-radius:14px; width:min(520px,92%); padding:18px}
    .modal h3{margin:6px 0 8px; color:var(--accent)}
    .modal p{margin:0 0 12px; color:var(--muted)}
    .modal .row{grid-template-columns:1fr auto}
    .modal .btn{padding:10px 14px; border-radius:10px; border:1px solid var(--line); background:#182032; color:#fff; cursor:pointer; font-weight:700}
    .modal .btn.secondary{background:#22283a}
    .center{display:flex; justify-content:center}
  </style>
</head>
<body>
  <nav style="width:100%;display:flex;justify-content:center;gap:30px;margin-bottom:30px;font-size:13px;">
  <a href="/privacy.html" style="color:#6ee7ff;text-decoration:none;">Privacy Policy</a>
  <a href="/terms.html" style="color:#6ee7ff;text-decoration:none;">Terms & Conditions</a>
  <a href="/about.html" style="color:#6ee7ff;text-decoration:none;">About Us</a>
    <a href="#" id="logoutLink" style="color:#6ee7ff;text-decoration:none;">Logout</a>
    <a href="#" id="manageBilling" style="color:#6ee7ff;text-decoration:none;display:none;">Manage Billing</a>
</nav>
  <div style="margin-bottom:30px;font-size:13px;color:#8b95a7;text-align:center;">
  The Urban Creator, Made Better.
</div>
 <div style="width:100%;padding:10px 0;text-align:center;font-size:13px;color:#8b95a7;">
  PostPoet is for modern storytellers. You get 10 free creations a day. Pro removes the limits.
</div>
  <div class="card">
    <h1>PostPoet</h1>
<p class="sub">AI that writes like a human who actually thinks. Craft captions, hooks and headlines with quiet clarity.</p>
<p class="sub" style="margin-top:6px;color:#6ee7ff;font-size:13px;opacity:.8;">Created for creators who prefer calm impact over algorithmic noise.</p>


    <div class="row">
      <div>
        <label for="desc">Describe your image or post</label>
        <textarea id="desc" rows="4" placeholder="Example: pint of lager on a sunny pub table in Preston"></textarea>
      </div>
      <div>
        <label for="tone">Tone</label>
        <select id="tone">
          <!-- Your tones + 3 extra moods -->
          <option>British witty</option>
          <option>American bold</option>
          <option>Australian laid-back</option>
          <option>Sarcastic</option>
          <option>Luxury</option>
          <option>Motivational</option>
          <option>Flirty</option>
          <option>Dark humour</option>
          <option>Empathetic supportive</option>
          <option>Melancholic reflective</option>
          <option>Savage roast</option>
        </select>

        <div class="actions">
          <button id="micBtn" class="badge lock" aria-label="Hold to speak" title="Pro only">
            üé§ Hold to speak <span class="badge pro">Pro</span>
          </button>
          <button id="generate" class="primary">Generate captions</button>
        </div>
        <div class="tooltip" id="proNote">Microphone is Pro only. Unlock for ¬£4.99/mo.</div>

        <div class="meta">
          <span id="limitInfo"></span>
          <span id="statusBadge" class="badge">Status: Checking‚Ä¶</span>
        </div>

       <button id="goPro"
  style="margin-top:14px;background:#202532;border:1px solid #3a4156;border-radius:10px;padding:12px 16px;font-weight:600;cursor:pointer;color:#e8ecf1;">
  Unlock Pro (Unlimited Captions, Plus Voiceflow) ‚Äì ¬£4.99/mo
</button>
      </div>
    </div>

    <div id="outputs"></div>
  </div>

  <!-- Email modal -->
  <div class="modal-backdrop" id="emailModal">
    <div class="modal">
      <h3>Quick thing, what‚Äôs your email?</h3>
      <p>We‚Äôll use this to check your Pro status. No spam, pinky promise.</p>
      <div class="row">
        <input id="emailInput" type="email" placeholder="you@example.com" />
        <button id="saveEmail" class="btn">Save</button>
      </div>
      <div class="center" style="margin-top:8px;">
        <button id="skipEmail" class="btn secondary">Skip for now</button>
      </div>
    </div>
  </div>

<script>
"use strict";

/* =============== CONFIG =============== */
const DAILY_LIMIT  = 10; // shared pool: mic + text
const CHECK_URL    = "https://postpoet-api.vercel.app/api/check";
const GENERATE_URL = "https://postpoet-api.vercel.app/api/generate";
const STRIPE_LINK  = "https://buy.stripe.com/5kQ4gyeFb5B4bZDb118Zq00";

/* =============== STATE + DOM =============== */
let isPro = false;
let email = localStorage.getItem("cc_email") || "";
let lastKnownPro = localStorage.getItem("lastKnownPro") === "true";

const $           = (id) => document.getElementById(id);
const limitInfo   = $("limitInfo");
const statusBadge = $("statusBadge");
const outputs     = $("outputs");
const micBtn      = $("micBtn");
const goProBtn    = $("goPro");
const modal       = $("emailModal");
const emailInput  = $("emailInput");
const saveEmail   = $("saveEmail");
const skipEmail   = $("skipEmail");
const descEl      = $("desc");
const toneEl      = $("tone");
const generateBtn = $("generate");
const proNote     = $("proNote");

/* =============== SHARED DAILY LIMIT (mic + text) =============== */
function getUsage(){
  const today  = new Date().toISOString().slice(0,10);
  const record = JSON.parse(localStorage.getItem("captionUsageShared") || "{}");
  if (record.date !== today) return { date: today, used: 0 };
  return record;
}
function saveUsage(data){ localStorage.setItem("captionUsageShared", JSON.stringify(data)); }
function canUse(){ return isPro ? true : getUsage().used < DAILY_LIMIT; }
function recordUse(){
  if (!isPro) {
    const d = getUsage();
    d.used += 1;
    saveUsage(d);
    updateLimitDisplay();
  }
}
function updateLimitDisplay(){
  const d = getUsage();
  if (limitInfo) limitInfo.textContent = `Free actions left today: ${Math.max(0, DAILY_LIMIT - d.used)} of ${DAILY_LIMIT}`;
}

/* =============== APPLY UI FOR PRO =============== */
function applyUIForPro(){
  // Mic never visually locked, we gate by limit
  micBtn.classList.remove("lock");
  micBtn.title = isPro ? "Hold to speak your idea, release to stop"
                       : "Hold to speak, counts toward your free daily limit";

  if (proNote) {
    proNote.style.display = isPro ? "none" : "block";
    proNote.textContent = isPro
      ? "Pro active, unlimited mic and captions."
      : "Mic and captions share 10 free uses per day. Pro unlocks unlimited.";
  }

  if (isPro) {
    if (statusBadge) statusBadge.textContent = "Status: Pro ‚úÖ";
    if (limitInfo)  limitInfo.textContent    = "Unlimited generations";
    if (goProBtn)   goProBtn.style.display   = "none";
    manageBilling.style.display = "inline";
  } else {
    if (statusBadge) statusBadge.textContent = "Status: Free";
    updateLimitDisplay();
    if (goProBtn)   goProBtn.style.display   = "block";
    manageBilling.style.display = "none";
  }
}

/* =============== PRO STATUS CHECK (optimistic, no flick) =============== */
async function refreshProStatus(){
  try {
    if (!email) {
      isPro = false;
      localStorage.setItem("lastKnownPro", "false");
      applyUIForPro();
      return;
    }

    const r = await fetch(CHECK_URL + "?email=" + encodeURIComponent(email), {
      method: "GET",
      headers: { "Accept":"application/json" }
    });

    if (!r.ok) {
      // stay on optimistic state, just ensure storage reflects false if needed
      if (isPro === false) localStorage.setItem("lastKnownPro", "false");
      applyUIForPro();
      console.warn("pro check failed", r.status);
      return;
    }

    const data = await r.json();
    const newState = !!(data && data.pro);

    // Only update UI if state changed, avoids late repaint lag
    if (newState !== isPro) {
      isPro = newState;
      localStorage.setItem("lastKnownPro", String(isPro));
      if (statusBadge) statusBadge.textContent = isPro ? "Status: Pro ‚úÖ" : "Status: Free";
      applyUIForPro();
    }
  } catch (err) {
    console.error("refreshProStatus error", err);
    // keep optimistic UI, don‚Äôt jiggle the state
  }
}

/* =============== EMAIL MODAL =============== */
function openModal(){ modal.style.display = "flex"; }
function closeModal(){ modal.style.display = "none"; }
function persistEmail(v){
  email = (v || "").trim();
  if (email) localStorage.setItem("cc_email", email);
}
if (!email) openModal();

saveEmail.addEventListener("click", async () => {
  const v = emailInput.value.trim();
  if (!v || !/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(v)) { alert("Pop a valid email in."); return; }
  persistEmail(v);
  closeModal();
  await refreshProStatus();
});
skipEmail.addEventListener("click", () => {
  closeModal();
  updateLimitDisplay();
  if (statusBadge) statusBadge.textContent = "Status: Guest (not Pro)";
});

/* =============== SPEECH TO TEXT (free until pool spent) =============== */
let recognition = null;
if ("webkitSpeechRecognition" in window) {
  recognition = new webkitSpeechRecognition();
  recognition.continuous    = false;
  recognition.interimResults= false;
  recognition.lang          = "en-GB";

  let buffer = "";
  let listening = false;

  function startMic(e) {
    if (e) e.preventDefault();
    if (!isPro && !canUse()) {
      alert("You‚Äôve used your free actions today. Go Pro for unlimited.");
      return;
    }
    if (listening) return;

    buffer = "";
    listening = true;

    outputs.insertAdjacentHTML("afterbegin", `<div class="out" id="live">üéôÔ∏è Listening‚Ä¶ speak your idea</div>`);
    try { recognition.start(); } catch (_) {}
  }

  function stopMic(e) {
    if (e) e.preventDefault();
    if (!listening) return;
    try { recognition.stop(); } catch (_) {}
  }

  // Desktop mouse press/hold
  micBtn.addEventListener("mousedown", startMic, { passive: false });
  micBtn.addEventListener("mouseup",   stopMic,  { passive: false });
  micBtn.addEventListener("mouseleave",stopMic,  { passive: false });

  // Mobile touch press/hold
  micBtn.addEventListener("touchstart", startMic, { passive: false });
  micBtn.addEventListener("touchend",   stopMic,  { passive: false });
  micBtn.addEventListener("touchcancel",stopMic,  { passive: false });

  // Single tap toggle
  micBtn.addEventListener("click", (e) => { if (!listening) startMic(e); else stopMic(e); });

  recognition.onresult = (event) => {
    for (let i = event.resultIndex; i < event.results.length; i++) {
      if (event.results[i].isFinal) {
        buffer += (buffer ? " " : "") + event.results[i][0].transcript;
      }
    }
    const live = document.getElementById("live");
    if (live) live.textContent = "üéôÔ∏è " + (buffer || "Listening‚Ä¶");
  };

  recognition.onerror = () => {
    listening = false;
    const live = document.getElementById("live");
    if (live) live.remove();
  };

  recognition.onend = () => {
    listening = false;
    const live = document.getElementById("live");
    if (live) live.remove();

    const text = (buffer || "").trim();
    if (text) {
      recordUse();
      descEl.value = (descEl.value ? descEl.value + " " : "") + text;
    }
  };
} else {
  micBtn.title = "Speech to text not supported in this browser";
}

/* =========================
   GENERATE CAPTIONS (server)
========================= */
generateBtn.addEventListener("click", async () => {
  const desc = (descEl.value || "").trim();
  const tone = toneEl.value;
  if (!desc) { alert("Write a quick description first."); return; }

  if (!isPro && !canUse()) {
    alert("You‚Äôve used your free captions today. Go Pro for unlimited.");
    return;
  }

  outputs.innerHTML = "<div class='out'>Thinking up captions‚Ä¶</div>";

  try {
    const r = await fetch(GENERATE_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ desc, tone, email })
    });

    if (!r.ok) {
      const t = await r.text();
      throw new Error(`API ${r.status}: ${t}`);
    }

    const { captions } = await r.json();
    recordUse();
    outputs.innerHTML = "";

    captions.forEach(line => {
      const pill = document.createElement("button");
      pill.textContent = line;
      pill.className   = "pillCopy";
      pill.style.cssText = "display:block;width:100%;text-align:left;background:#181f2d;border:1px solid #2e364b;border-radius:8px;padding:10px;margin-bottom:8px;color:#e8ecf1;cursor:pointer;font-size:14px;";

      pill.addEventListener("click", () => {
        navigator.clipboard.writeText(line);
        pill.style.borderColor="#6ee7ff";
        pill.style.background="#112030";
        pill.textContent="Copied ‚úÖ";
        setTimeout(()=>{
          pill.textContent=line;
          pill.style.borderColor="#2e364b";
          pill.style.background="#181f2d";
        },900);
      });

      outputs.appendChild(pill);
    });

  } catch (e) {
    outputs.innerHTML = `<div class="out" style="color:#ff6b6b">Error: ${e.message}</div>`;
    console.error(e);
  }
});

/* =============== GO PRO (same tab) =============== */
goProBtn.addEventListener("click", () => {
  window.location.href = STRIPE_LINK;
});
const logoutLink = $("logoutLink");
logoutLink.addEventListener("click", (e) => {
  e.preventDefault();
  localStorage.removeItem("cc_email");
  localStorage.removeItem("lastKnownPro");
  localStorage.removeItem("captionUsageShared");
  window.location.reload();
});
 const manageBilling = $("manageBilling");
manageBilling.addEventListener("click", (e) => {
  e.preventDefault();
  window.location.href = "https://billing.stripe.com/p/login/5kQ4gyeFb5B4bZDb118Zq00";
});
/* =============== BOOT =============== */
(function boot(){
  try {
    if (email) emailInput.value = email;

    micBtn.classList.remove("lock");
    updateLimitDisplay();

    // Optimistic paint: use last known state immediately, then verify in background
    isPro = lastKnownPro;
    if (statusBadge) statusBadge.textContent = isPro ? "Status: Pro ‚úÖ" : "Status: Free";
    applyUIForPro();

    // Background verification, only repaints if state changes
    refreshProStatus();
  } catch (e) {
    console.error("boot error", e);
  }
})();

/* =============== BACK FROM STRIPE/TAB FOCUS =============== */
document.addEventListener("visibilitychange", ()=>{
  if (document.visibilityState === "visible") refreshProStatus();
});
</script>
</body>
</html>


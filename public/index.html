<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>CaptionCraft ‚Äì AI Caption Generator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0f1115; --card:#171a21; --muted:#8b95a7; --line:#2f3852; --text:#e8ecf1; --accent:#6ee7ff;
    }
    *{box-sizing:border-box}
   body{
  margin:0;
  font-family:system-ui,sans-serif;
  background:#0f1115;
  color:#e8ecf1;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:flex-start;
  min-height:100vh;
  padding-top:30px;
}
    .card{
      width:100%; max-width:900px; background:var(--card); border:1px solid var(--line);
      border-radius:16px; padding:22px; box-shadow:0 10px 36px rgba(0,0,0,.45);
    }
    h1{margin:0 0 8px; text-align:center; color:var(--accent)}
    .sub{margin:0 0 18px; text-align:center; color:var(--muted); font-size:14px}
    label{display:block; margin:12px 0 6px; color:var(--muted); font-size:14px}
    textarea,input,select,button{
      width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--line); background:#0e121a; color:var(--text); font-size:14px;
    }
    select{cursor:pointer}
    .row{display:grid; gap:12px}
    @media(min-width:720px){ .row{grid-template-columns:2fr 1fr} }
    button.primary{
      margin-top:14px; font-weight:700; cursor:pointer;
      background:linear-gradient(180deg,#1b2640,#121a2d);
      box-shadow:0 4px 12px rgba(84,164,255,.18);
    }
    .meta{display:flex; gap:10px; align-items:center; margin-top:8px; font-size:13px; color:var(--muted)}
    .badge{display:inline-flex; align-items:center; gap:6px; font-size:12px; padding:4px 8px; border:1px solid var(--line); border-radius:999px; color:var(--muted)}
    .pro{border-color:#3aa471; color:#87e4a5}
    .danger{color:#ff6b6b}
    #outputs{margin-top:20px; display:grid; gap:10px}
    .out{background:#0f1420; border:1px solid #232838; border-radius:12px; padding:10px}
    .actions{display:flex; gap:10px; flex-wrap:wrap; margin-top:8px}
    .lock{opacity:.55; cursor:not-allowed}
    .tooltip{font-size:12px; color:var(--muted)}

    /* Modal */
    .modal-backdrop{
      position:fixed; inset:0; background:rgba(0,0,0,.6);
      display:none; align-items:center; justify-content:center; z-index:9999;
    }
    .modal{background:#121621; border:1px solid var(--line); border-radius:14px; width:min(520px,92%); padding:18px}
    .modal h3{margin:6px 0 8px; color:var(--accent)}
    .modal p{margin:0 0 12px; color:var(--muted)}
    .modal .row{grid-template-columns:1fr auto}
    .modal .btn{padding:10px 14px; border-radius:10px; border:1px solid var(--line); background:#182032; color:#fff; cursor:pointer; font-weight:700}
    .modal .btn.secondary{background:#22283a}
    .center{display:flex; justify-content:center}
  </style>
</head>
<body>
  <nav style="width:100%;display:flex;justify-content:center;gap:30px;margin-bottom:30px;font-size:13px;">
  <a href="/privacy.html" style="color:#6ee7ff;text-decoration:none;">Privacy Policy</a>
  <a href="/terms.html" style="color:#6ee7ff;text-decoration:none;">Terms & Conditions</a>
  <a href="/about.html" style="color:#6ee7ff;text-decoration:none;">About Us</a>
</nav>
  <div class="card">
    <h1>CaptionCraft</h1>
    <p class="sub">Talk ideas out loud, get punchy captions back. Accessibility-first, creator-ready.</p>

    <div class="row">
      <div>
        <label for="desc">Describe your image or post</label>
        <textarea id="desc" rows="4" placeholder="Example: pint of lager on a sunny pub table in Preston"></textarea>
      </div>
      <div>
        <label for="tone">Tone</label>
        <select id="tone">
          <!-- Your tones + 3 extra moods -->
          <option>British witty</option>
          <option>American bold</option>
          <option>Australian laid-back</option>
          <option>Sarcastic</option>
          <option>Luxury</option>
          <option>Motivational</option>
          <option>Flirty</option>
          <option>Dark humour</option>
          <option>Empathetic supportive</option>
          <option>Melancholic reflective</option>
          <option>Savage roast</option>
        </select>

        <div class="actions">
          <button id="micBtn" class="badge lock" aria-label="Hold to speak" title="Pro only">
            üé§ Hold to speak <span class="badge pro">Pro</span>
          </button>
          <button id="generate" class="primary">Generate captions</button>
        </div>
        <div class="tooltip" id="proNote">Microphone is Pro only. Unlock for ¬£4.99/mo.</div>

        <div class="meta">
          <span id="limitInfo"></span>
          <span id="statusBadge" class="badge">Status: Checking‚Ä¶</span>
        </div>

        <button id="goPro"
          style="margin-top:10px;background:#2b2f47;border:1px solid #555;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer">
          Go Pro ‚Äì Unlimited Captions ¬£4.99/mo
        </button>
      </div>
    </div>

    <div id="outputs"></div>
  </div>

  <!-- Email modal -->
  <div class="modal-backdrop" id="emailModal">
    <div class="modal">
      <h3>Quick thing, what‚Äôs your email?</h3>
      <p>We‚Äôll use this to check your Pro status. No spam, pinky promise.</p>
      <div class="row">
        <input id="emailInput" type="email" placeholder="you@example.com" />
        <button id="saveEmail" class="btn">Save</button>
      </div>
      <div class="center" style="margin-top:8px;">
        <button id="skipEmail" class="btn secondary">Skip for now</button>
      </div>
    </div>
  </div>

 <script>
"use strict";

/* =============== CONFIG =============== */
const DAILY_LIMIT = 10;                   // shared pool: mic + text together
const CHECK_URL   = "/api/check";
const GENERATE_URL= "/api/generate";
const STRIPE_LINK = "https://buy.stripe.com/test_14AeVcapJdTd20Weos43S00"; // keep your link

/* =============== STATE + DOM =============== */
let isPro = false;
let email = localStorage.getItem("cc_email") || "";

const $          = (id) => document.getElementById(id);
const limitInfo  = $("limitInfo");
const statusBadge= $("statusBadge");
const outputs    = $("outputs");
const micBtn     = $("micBtn");
const goProBtn   = $("goPro");
const modal      = $("emailModal");
const emailInput = $("emailInput");
const saveEmail  = $("saveEmail");
const skipEmail  = $("skipEmail");
const descEl     = $("desc");
const toneEl     = $("tone");
const generateBtn= $("generate");
const proNote    = $("proNote");

/* =============== EMAIL MODAL =============== */
function openModal(){ modal.style.display = "flex"; }
function closeModal(){ modal.style.display = "none"; }
function persistEmail(v){
  email = (v || "").trim();
  if (email) localStorage.setItem("cc_email", email);
}
if (!email) openModal();

saveEmail.addEventListener("click", async () => {
  const v = emailInput.value.trim();
  if (!v || !/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(v)) { alert("Pop a valid email in."); return; }
  persistEmail(v);
  closeModal();
  await refreshProStatus();
});
skipEmail.addEventListener("click", () => {
  closeModal();
  updateLimitDisplay();
  statusBadge.textContent = "Status: Guest (not Pro)";
});

/* =============== PRO CHECK =============== */
async function refreshProStatus(){
  if (!email) { isPro = false; applyUIForPro(); return; }
  statusBadge.textContent = "Status: Checking‚Ä¶";
  try {
    const r = await fetch(`${CHECK_URL}?email=${encodeURIComponent(email)}`, { cache: "no-store" });
    const j = await r.json();
    isPro = !!j.pro;
    applyUIForPro();
  } catch (e) {
    console.error("check error", e);
    statusBadge.textContent = "Status: Error, defaulting to Free";
    isPro = false;
    applyUIForPro();
  }
}

function applyUIForPro(){
  // Mic is available on free until the limit is spent, so never hard-lock the button by class
  micBtn.classList.remove("lock");
  micBtn.title = isPro ? "Hold to speak your idea, release to stop"
                       : "Hold to speak, counts toward your free daily limit";

  if (proNote) {
    proNote.textContent = isPro
      ? "Pro active, unlimited mic and captions."
      : "Mic and captions share 10 free uses per day. Pro unlocks unlimited.";
  }

  if (isPro) {
    statusBadge.textContent = "Status: Pro ‚úÖ";
    limitInfo.textContent   = "Unlimited generations";
  } else {
    statusBadge.textContent = "Status: Free";
    updateLimitDisplay();
  }
}

/* =============== SHARED DAILY LIMIT (mic + text) =============== */
function getUsage(){
  const today = new Date().toISOString().slice(0,10);
  const record = JSON.parse(localStorage.getItem("captionUsageShared") || "{}");
  if (record.date !== today) return { date: today, used: 0 };
  return record;
}
function saveUsage(data){ localStorage.setItem("captionUsageShared", JSON.stringify(data)); }
function canUse(){ return isPro ? true : getUsage().used < DAILY_LIMIT; }
function recordUse(){
  if (!isPro) {
    const d = getUsage();
    d.used += 1;
    saveUsage(d);
    updateLimitDisplay();
  }
}
function updateLimitDisplay(){
  const d = getUsage();
  limitInfo.textContent = `Free actions left today: ${Math.max(0, DAILY_LIMIT - d.used)} of ${DAILY_LIMIT}`;
}

/* =============== SPEECH TO TEXT (free until pool spent) =============== */
let recognition = null;
if ("webkitSpeechRecognition" in window) {
  recognition = new webkitSpeechRecognition();
  recognition.continuous = true;
  recognition.interimResults = true;
  recognition.lang = "en-GB";
  let buffer = "";

  micBtn.addEventListener("mousedown", () => {
    if (!isPro && !canUse()) { alert("You‚Äôve used your free actions today. Go Pro for unlimited."); return; }
    buffer = "";
    outputs.insertAdjacentHTML("afterbegin", `<div class="out" id="live">üéôÔ∏è Listening‚Ä¶ speak your idea</div>`);
    try { recognition.start(); } catch (_) {}
  });

  micBtn.addEventListener("mouseup", () => {
    try { recognition.stop(); } catch (_) {}
    const live = $("live");
    if (live) live.remove();
    if (buffer.trim()) {
      // Mic counts as one action when you finish talking
      recordUse();
      descEl.value = (descEl.value ? descEl.value + " " : "") + buffer.trim();
    }
  });

  recognition.onresult = (event) => {
    let interim = "";
    for (let i = event.resultIndex; i < event.results.length; i++) {
      const tr = event.results[i][0].transcript;
      if (event.results[i].isFinal) buffer += " " + tr;
      else interim += tr;
    }
    const live = $("live");
    if (live) live.textContent = "üéôÔ∏è " + (buffer + " " + interim).trim();
  };
} else {
  micBtn.title = "Speech to text not supported in this browser";
}

/* =============== GENERATE (server) =============== */
generateBtn.addEventListener("click", async () => {
  const desc = (descEl.value || "").trim();
  const tone = toneEl.value;
  if (!desc) { alert("Write a quick description first."); return; }

  if (!isPro && !canUse()) {
    alert("You‚Äôve used your free actions today. Go Pro for unlimited.");
    return;
  }

  outputs.innerHTML = "<div class='out'>Thinking up captions‚Ä¶</div>";

  try {
    const r = await fetch(GENERATE_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ desc, tone }) // email not required for generate
    });
    if (!r.ok) {
      const t = await r.text();
      throw new Error(`API ${r.status}: ${t}`);
    }
    const { captions } = await r.json();
    recordUse();
    outputs.innerHTML = "";
    (captions || []).forEach(line => {
      const el = document.createElement("div");
      el.className = "out";
      el.textContent = line;
      outputs.appendChild(el);
    });
  } catch (e) {
    outputs.innerHTML = `<div class="out" style="color:#ff6b6b">Error: ${e.message}</div>`;
    console.error(e);
  }
});

/* =============== GO PRO (same tab) =============== */
goProBtn.addEventListener("click", () => {
  window.location.href = STRIPE_LINK;
});

/* =============== BOOT =============== */
(function boot(){
  try {
    if (email) emailInput.value = email;
    // never keep mic visually locked, we gate by limit now
    micBtn.classList.remove("lock");
    updateLimitDisplay();
    refreshProStatus();
  } catch (e) {
    console.error("boot error", e);
  }
})();

// Re-check Pro when user returns from Stripe tab
document.addEventListener("visibilitychange", ()=>{
  if (document.visibilityState === "visible") refreshProStatus();
});
</script>
</body>
</html>

